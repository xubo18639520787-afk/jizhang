name: ä¸ªäººè®°è´¦åº”ç”¨ - äº‘ç«¯æž„å»º

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æž„å»º

jobs:
  build:
    name: æž„å»º Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ç”¨äºŽç‰ˆæœ¬å·ç”Ÿæˆ

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: è®¾ç½® Android SDK
      uses: android-actions/setup-android@v3

    - name: ç¼“å­˜ Gradle ä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: æŽˆäºˆ gradlew æ‰§è¡Œæƒé™
      run: chmod +x gradlew

    - name: éªŒè¯ Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: æ¸…ç†é¡¹ç›®
      run: ./gradlew clean

    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: ./gradlew ktlintCheck
      continue-on-error: true

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: ./gradlew testDebugUnitTest
      continue-on-error: true

    - name: æž„å»º Debug APK
      run: ./gradlew assembleDebug

    - name: æž„å»º Release APK
      run: ./gradlew assembleRelease

    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION_NAME=$(grep "versionName" app/build.gradle.kts | cut -d'"' -f2)
        VERSION_CODE=$(grep "versionCode" app/build.gradle.kts | awk '{print $3}')
        COMMIT_SHA=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date '+%Y%m%d_%H%M%S')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

    - name: é‡å‘½å APK æ–‡ä»¶
      run: |
        mkdir -p artifacts
        cp app/build/outputs/apk/debug/app-debug.apk artifacts/PersonalAccounting_v${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_time }}.apk
        cp app/build/outputs/apk/release/app-release-unsigned.apk artifacts/PersonalAccounting_v${{ steps.version.outputs.version_name }}_release_${{ steps.version.outputs.build_time }}.apk

    - name: ä¸Šä¼  Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: PersonalAccounting-Debug-APK
        path: artifacts/*debug*.apk
        retention-days: 30

    - name: ä¸Šä¼  Release APK
      uses: actions/upload-artifact@v4
      with:
        name: PersonalAccounting-Release-APK
        path: artifacts/*release*.apk
        retention-days: 30

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          app/build/reports/tests/
          app/build/reports/ktlint/
        retention-days: 7

    - name: æž„å»ºæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸš€ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version_name }} (Build ${{ steps.version.outputs.version_code }})" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ steps.version.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- Debug APK: PersonalAccounting_v${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_time }}.apk" >> $GITHUB_STEP_SUMMARY
        echo "- Release APK: PersonalAccounting_v${{ steps.version.outputs.version_name }}_release_${{ steps.version.outputs.build_time }}.apk" >> $GITHUB_STEP_SUMMARY
